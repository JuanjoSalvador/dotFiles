'use babel';
/* eslint-env jasmine */

describe('FuzzyProvider', function () {
  var _ref = [];
  var completionDelay = _ref[0];
  var editor = _ref[1];
  var mainModule = _ref[2];
  var autocompleteManager = _ref[3];

  beforeEach(function () {
    atom.config.set('autocomplete-plus.includeCompletionsFromAllBuffers', false);

    // Set to live completion
    atom.config.set('autocomplete-plus.enableAutoActivation', true);
    atom.config.set('autocomplete-plus.defaultProvider', 'Fuzzy');

    // Set the completion delay
    completionDelay = 100;
    atom.config.set('autocomplete-plus.autoActivationDelay', completionDelay);
    completionDelay += 100; // Rendering delaya\

    var workspaceElement = atom.views.getView(atom.workspace);
    jasmine.attachToDOM(workspaceElement);
  });

  describe('when auto-activation is enabled', function () {
    beforeEach(function () {
      waitsForPromise(function () {
        return Promise.all([atom.packages.activatePackage('language-javascript'), atom.workspace.open('sample.js').then(function (e) {
          editor = e;
        }), atom.packages.activatePackage('autocomplete-plus').then(function (a) {
          mainModule = a.mainModule;
        })]);
      });

      runs(function () {
        autocompleteManager = mainModule.autocompleteManager;
        advanceClock(mainModule.autocompleteManager.providerManager.defaultProvider.deferBuildWordListInterval);
      });
    });

    it('adds words to the wordlist after they have been written', function () {
      editor.moveToBottom();
      editor.moveToBeginningOfLine();
      var provider = autocompleteManager.providerManager.defaultProvider;

      expect(provider.tokenList.getToken('somethingNew')).toBeUndefined();
      editor.insertText('somethingNew');
      expect(provider.tokenList.getToken('somethingNew')).toBe('somethingNew');
    });

    describe('when `editor.largeFileMode` is true', function () {
      return it("doesn't add words to the wordlist when the buffer changes", function () {
        var provider = autocompleteManager.providerManager.defaultProvider;
        var coffeeEditor = null;

        waitsForPromise(function () {
          return atom.packages.activatePackage('language-coffee-script');
        });

        waitsForPromise(function () {
          return atom.workspace.open('sample.coffee').then(function (e) {
            coffeeEditor = e;
            coffeeEditor.largeFileMode = true;
          });
        });

        runs(function () {
          advanceClock(provider.deferBuildWordListInterval);
          expect(provider.tokenList.getToken('SomeModule')).toBeUndefined();

          coffeeEditor.getBuffer().insert([0, 0], 'abc');
          advanceClock(provider.deferBuildWordListInterval);
          expect(provider.tokenList.getToken('abcSomeModule')).toBeUndefined();
        });
      });
    });

    it('removes words that are no longer in the buffer', function () {
      editor.moveToBottom();
      editor.moveToBeginningOfLine();
      var provider = autocompleteManager.providerManager.defaultProvider;

      expect(provider.tokenList.getToken('somethingNew')).toBeUndefined();
      editor.insertText('somethingNew');
      expect(provider.tokenList.getToken('somethingNew')).toBe('somethingNew');

      editor.backspace();
      expect(provider.tokenList.getToken('somethingNew')).toBe(undefined);
      expect(provider.tokenList.getToken('somethingNe')).toBe('somethingNe');
    });

    it('adds completions from editor.completions', function () {
      var provider = autocompleteManager.providerManager.defaultProvider;
      atom.config.set('editor.completions', ['abcd', 'abcde', 'abcdef'], { scopeSelector: '.source.js' });

      editor.moveToBottom();
      editor.insertText('ab');

      var bufferPosition = editor.getLastCursor().getBufferPosition();
      var scopeDescriptor = editor.getRootScopeDescriptor();
      var prefix = 'ab';

      var results = provider.getSuggestions({ editor: editor, bufferPosition: bufferPosition, scopeDescriptor: scopeDescriptor, prefix: prefix });
      expect(results[0].text).toBe('abcd');
    });

    it('adds completions from settings', function () {
      var provider = autocompleteManager.providerManager.defaultProvider;
      atom.config.set('editor.completions', { builtin: {
          suggestions: ['nope']
        } }, {
        scopeSelector: '.source.js'
      });

      editor.moveToBottom();
      editor.insertText('ab');

      var bufferPosition = editor.getLastCursor().getBufferPosition();
      var scopeDescriptor = editor.getRootScopeDescriptor();
      var prefix = 'ab';

      var results = provider.getSuggestions({ editor: editor, bufferPosition: bufferPosition, scopeDescriptor: scopeDescriptor, prefix: prefix });
      expect(results).toBeUndefined();
    });

    it('adds words to the wordlist with unicode characters', function () {
      atom.config.set('autocomplete-plus.enableExtendedUnicodeSupport', true);
      editor.moveToBottom();
      editor.moveToBeginningOfLine();
      var provider = autocompleteManager.providerManager.defaultProvider;

      expect(provider.tokenList.getToken('somthingNew')).toBeUndefined();
      editor.insertText('somthingNew');
      expect(provider.tokenList.getToken('somthingNew')).toBe('somthingNew');
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2p1YW5qby8uYXRvbS9wYWNrYWdlcy9hdXRvY29tcGxldGUtcGx1cy9zcGVjL2Z1enp5LXByb3ZpZGVyLXNwZWMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFBOzs7QUFHWCxRQUFRLENBQUMsZUFBZSxFQUFFLFlBQU07YUFDbUMsRUFBRTtNQUE5RCxlQUFlO01BQUUsTUFBTTtNQUFFLFVBQVU7TUFBRSxtQkFBbUI7O0FBRTdELFlBQVUsQ0FBQyxZQUFNO0FBQ2YsUUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsb0RBQW9ELEVBQUUsS0FBSyxDQUFDLENBQUE7OztBQUc1RSxRQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyx3Q0FBd0MsRUFBRSxJQUFJLENBQUMsQ0FBQTtBQUMvRCxRQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsRUFBRSxPQUFPLENBQUMsQ0FBQTs7O0FBRzdELG1CQUFlLEdBQUcsR0FBRyxDQUFBO0FBQ3JCLFFBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHVDQUF1QyxFQUFFLGVBQWUsQ0FBQyxDQUFBO0FBQ3pFLG1CQUFlLElBQUksR0FBRyxDQUFBOztBQUV0QixRQUFJLGdCQUFnQixHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtBQUN6RCxXQUFPLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUE7R0FDdEMsQ0FBQyxDQUFBOztBQUVGLFVBQVEsQ0FBQyxpQ0FBaUMsRUFBRSxZQUFNO0FBQ2hELGNBQVUsQ0FBQyxZQUFNO0FBQ2YscUJBQWUsQ0FBQztlQUNkLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FDVixJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxxQkFBcUIsQ0FBQyxFQUNwRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFB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cUJBQXFCLEVBQUUsQ0FBQTtBQUM5QixVQUFJLFFBQVEsR0FBRyxtQkFBbUIsQ0FBQyxlQUFlLENBQUMsZUFBZSxDQUFBOztBQUVsRSxZQUFNLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQTtBQUNuRSxZQUFNLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxDQUFBO0FBQ2pDLFlBQU0sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQTtLQUN6RSxDQUFDLENBQUE7R0FDSCxDQUFDLENBQUE7Q0FDSCxDQUFDLENBQUEiLCJmaWxlIjoiL2hvbWUvanVhbmpvLy5hdG9tL3BhY2thZ2VzL2F1dG9jb21wbGV0ZS1wbHVzL3NwZWMvZnV6enktcHJvdmlkZXItc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnXG4vKiBlc2xpbnQtZW52IGphc21pbmUgKi9cblxuZGVzY3JpYmUoJ0Z1enp5UHJvdmlkZXInLCAoKSA9PiB7XG4gIGxldCBbY29tcGxldGlvbkRlbGF5LCBlZGl0b3IsIG1haW5Nb2R1bGUsIGF1dG9jb21wbGV0ZU1hbmFnZXJdID0gW11cblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBhdG9tLmNvbmZpZy5zZXQoJ2F1dG9jb21wbGV0ZS1wbHVzLmluY2x1ZGVDb21wbGV0aW9uc0Zyb21BbGxCdWZmZXJzJywgZmFsc2UpXG5cbiAgICAvLyBTZXQgdG8gbGl2ZSBjb21wbGV0aW9uXG4gICAgYXRvbS5jb25maWcuc2V0KCdhdXRvY29tcGxldGUtcGx1cy5lbmFibGVBdXRvQWN0aXZhdGlvbicsIHRydWUpXG4gICAgYXRvbS5jb25maWcuc2V0KCdhdXRvY29tcGxldGUtcGx1cy5kZWZhdWx0UHJvdmlkZXInLCAnRnV6enknKVxuXG4gICAgLy8gU2V0IHRoZSBjb21wbGV0aW9uIGRlbGF5XG4gICAgY29tcGxldGlvbkRlbGF5ID0gMTAwXG4gICAgYXRvbS5jb25maWcuc2V0KCdhdXRvY29tcGxldGUtcGx1cy5hdXRvQWN0aXZhdGlvbkRlbGF5JywgY29tcGxldGlvbkRlbGF5KVxuICAgIGNvbXBsZXRpb25EZWxheSArPSAxMDAgLy8gUmVuZGVyaW5nIGRlbGF5YVxcXG5cbiAgICBsZXQgd29ya3NwYWNlRWxlbWVudCA9IGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSlcbiAgICBqYXNtaW5lLmF0dGFjaFRvRE9NKHdvcmtzcGFjZUVsZW1lbnQpXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ3doZW4gYXV0by1hY3RpdmF0aW9uIGlzIGVuYWJsZWQnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICB3YWl0c0ZvclByb21pc2UoKCkgPT5cbiAgICAgICAgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgIGF0b20ucGFja2FnZXMuYWN0aXZhdGVQYWNrYWdlKCdsYW5ndWFnZS1qYXZhc2NyaXB0JyksXG4gICAgICAgICAgYXRvbS53b3Jrc3BhY2Uub3Blbignc2FtcGxlLmpzJykudGhlbigoZSkgPT4geyBlZGl0b3IgPSBlIH0pLFxuICAgICAgICAgIGF0b20ucGFja2FnZXMuYWN0aXZhdGVQYWNrYWdlKCdhdXRvY29tcGxldGUtcGx1cycpLnRoZW4oKGEpID0+IHsgbWFpbk1vZHVsZSA9IGEubWFpbk1vZHVsZSB9KVxuICAgICAgICBdKSlcblxuICAgICAgcnVucygoKSA9PiB7XG4gICAgICAgIGF1dG9jb21wbGV0ZU1hbmFnZXIgPSBtYWluTW9kdWxlLmF1dG9jb21wbGV0ZU1hbmFnZXJcbiAgICAgICAgYWR2YW5jZUNsb2NrKG1haW5Nb2R1bGUuYXV0b2NvbXBsZXRlTWFuYWdlci5wcm92aWRlck1hbmFnZXIuZGVmYXVsdFByb3ZpZGVyLmRlZmVyQnVpbGRXb3JkTGlzdEludGVydmFsKVxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgaXQoJ2FkZHMgd29yZHMgdG8gdGhlIHdvcmRsaXN0IGFmdGVyIHRoZXkgaGF2ZSBiZWVuIHdyaXR0ZW4nLCAoKSA9PiB7XG4gICAgICBlZGl0b3IubW92ZVRvQm90dG9tKClcbiAgICAgIGVkaXRvci5tb3ZlVG9CZWdpbm5pbmdPZkxpbmUoKVxuICAgICAgbGV0IHByb3ZpZGVyID0gYXV0b2NvbXBsZXRlTWFuYWdlci5wcm92aWRlck1hbmFnZXIuZGVmYXVsdFByb3ZpZGVyXG5cbiAgICAgIGV4cGVjdChwcm92aWRlci50b2tlbkxpc3QuZ2V0VG9rZW4oJ3NvbWV0aGluZ05ldycpKS50b0JlVW5kZWZpbmVkKClcbiAgICAgIGVkaXRvci5pbnNlcnRUZXh0KCdzb21ldGhpbmdOZXcnKVxuICAgICAgZXhwZWN0KHByb3ZpZGVyLnRva2VuTGlzdC5nZXRUb2tlbignc29tZXRoaW5nTmV3JykpLnRvQmUoJ3NvbWV0aGluZ05ldycpXG4gICAgfSlcblxuICAgIGRlc2NyaWJlKCd3aGVuIGBlZGl0b3IubGFyZ2VGaWxlTW9kZWAgaXMgdHJ1ZScsICgpID0+XG4gICAgICBpdChcImRvZXNuJ3QgYWRkIHdvcmRzIHRvIHRoZSB3b3JkbGlzdCB3aGVuIHRoZSBidWZmZXIgY2hhbmdlc1wiLCAoKSA9PiB7XG4gICAgICAgIGxldCBwcm92aWRlciA9IGF1dG9jb21wbGV0ZU1hbmFnZXIucHJvdmlkZXJNYW5hZ2VyLmRlZmF1bHRQcm92aWRlclxuICAgICAgICBsZXQgY29mZmVlRWRpdG9yID0gbnVsbFxuXG4gICAgICAgIHdhaXRzRm9yUHJvbWlzZSgoKSA9PiBhdG9tLnBhY2thZ2VzLmFjdGl2YXRlUGFja2FnZSgnbGFuZ3VhZ2UtY29mZmVlLXNjcmlwdCcpKVxuXG4gICAgICAgIHdhaXRzRm9yUHJvbWlzZSgoKSA9PlxuICAgICAgICAgIGF0b20ud29ya3NwYWNlLm9wZW4oJ3NhbXBsZS5jb2ZmZWUnKS50aGVuKChlKSA9PiB7XG4gICAgICAgICAgICBjb2ZmZWVFZGl0b3IgPSBlXG4gICAgICAgICAgICBjb2ZmZWVFZGl0b3IubGFyZ2VGaWxlTW9kZSA9IHRydWVcbiAgICAgICAgICB9KVxuICAgICAgICApXG5cbiAgICAgICAgcnVucygoKSA9PiB7XG4gICAgICAgICAgYWR2YW5jZUNsb2NrKHByb3ZpZGVyLmRlZmVyQnVpbGRXb3JkTGlzdEludGVydmFsKVxuICAgICAgICAgIGV4cGVjdChwcm92aWRlci50b2tlbkxpc3QuZ2V0VG9rZW4oJ1NvbWVNb2R1bGUnKSkudG9CZVVuZGVmaW5lZCgpXG5cbiAgICAgICAgICBjb2ZmZWVFZGl0b3IuZ2V0QnVmZmVyKCkuaW5zZXJ0KFswLCAwXSwgJ2FiYycpXG4gICAgICAgICAgYWR2YW5jZUNsb2NrKHByb3ZpZGVyLmRlZmVyQnVpbGRXb3JkTGlzdEludGVydmFsKVxuICAgICAgICAgIGV4cGVjdChwcm92aWRlci50b2tlbkxpc3QuZ2V0VG9rZW4oJ2FiY1NvbWVNb2R1bGUnKSkudG9CZVVuZGVmaW5lZCgpXG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIClcblxuICAgIGl0KCdyZW1vdmVzIHdvcmRzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgYnVmZmVyJywgKCkgPT4ge1xuICAgICAgZWRpdG9yLm1vdmVUb0JvdHRvbSgpXG4gICAgICBlZGl0b3IubW92ZVRvQmVnaW5uaW5nT2ZMaW5lKClcbiAgICAgIGxldCBwcm92aWRlciA9IGF1dG9jb21wbGV0ZU1hbmFnZXIucHJvdmlkZXJNYW5hZ2VyLmRlZmF1bHRQcm92aWRlclxuXG4gICAgICBleHBlY3QocHJvdmlkZXIudG9rZW5MaXN0LmdldFRva2VuKCdzb21ldGhpbmdOZXcnKSkudG9CZVVuZGVmaW5lZCgpXG4gICAgICBlZGl0b3IuaW5zZXJ0VGV4dCgnc29tZXRoaW5nTmV3JylcbiAgICAgIGV4cGVjdChwcm92aWRlci50b2tlbkxpc3QuZ2V0VG9rZW4oJ3NvbWV0aGluZ05ldycpKS50b0JlKCdzb21ldGhpbmdOZXcnKVxuXG4gICAgICBlZGl0b3IuYmFja3NwYWNlKClcbiAgICAgIGV4cGVjdChwcm92aWRlci50b2tlbkxpc3QuZ2V0VG9rZW4oJ3NvbWV0aGluZ05ldycpKS50b0JlKHVuZGVmaW5lZClcbiAgICAgIGV4cGVjdChwcm92aWRlci50b2tlbkxpc3QuZ2V0VG9rZW4oJ3NvbWV0aGluZ05lJykpLnRvQmUoJ3NvbWV0aGluZ05lJylcbiAgICB9KVxuXG4gICAgaXQoJ2FkZHMgY29tcGxldGlvbnMgZnJvbSBlZGl0b3IuY29tcGxldGlvbnMnLCAoKSA9PiB7XG4gICAgICBsZXQgcHJvdmlkZXIgPSBhdXRvY29tcGxldGVNYW5hZ2VyLnByb3ZpZGVyTWFuYWdlci5kZWZhdWx0UHJvdmlkZXJcbiAgICAgIGF0b20uY29uZmlnLnNldCgnZWRpdG9yLmNvbXBsZXRpb25zJywgWydhYmNkJywgJ2FiY2RlJywgJ2FiY2RlZiddLCB7c2NvcGVTZWxlY3RvcjogJy5zb3VyY2UuanMnfSlcblxuICAgICAgZWRpdG9yLm1vdmVUb0JvdHRvbSgpXG4gICAgICBlZGl0b3IuaW5zZXJ0VGV4dCgnYWInKVxuXG4gICAgICBsZXQgYnVmZmVyUG9zaXRpb24gPSBlZGl0b3IuZ2V0TGFzdEN1cnNvcigpLmdldEJ1ZmZlclBvc2l0aW9uKClcbiAgICAgIGxldCBzY29wZURlc2NyaXB0b3IgPSBlZGl0b3IuZ2V0Um9vdFNjb3BlRGVzY3JpcHRvcigpXG4gICAgICBsZXQgcHJlZml4ID0gJ2FiJ1xuXG4gICAgICBsZXQgcmVzdWx0cyA9IHByb3ZpZGVyLmdldFN1Z2dlc3Rpb25zKHtlZGl0b3IsIGJ1ZmZlclBvc2l0aW9uLCBzY29wZURlc2NyaXB0b3IsIHByZWZpeH0pXG4gICAgICBleHBlY3QocmVzdWx0c1swXS50ZXh0KS50b0JlKCdhYmNkJylcbiAgICB9KVxuXG4gICAgaXQoJ2FkZHMgY29tcGxldGlvbnMgZnJvbSBzZXR0aW5ncycsICgpID0+IHtcbiAgICAgIGxldCBwcm92aWRlciA9IGF1dG9jb21wbGV0ZU1hbmFnZXIucHJvdmlkZXJNYW5hZ2VyLmRlZmF1bHRQcm92aWRlclxuICAgICAgYXRvbS5jb25maWcuc2V0KCdlZGl0b3IuY29tcGxldGlvbnMnLCB7IGJ1aWx0aW46IHtcbiAgICAgICAgc3VnZ2VzdGlvbnM6IFsnbm9wZSddXG4gICAgICB9fSwge1xuICAgICAgICBzY29wZVNlbGVjdG9yOiAnLnNvdXJjZS5qcydcbiAgICAgIH0pXG5cbiAgICAgIGVkaXRvci5tb3ZlVG9Cb3R0b20oKVxuICAgICAgZWRpdG9yLmluc2VydFRleHQoJ2FiJylcblxuICAgICAgbGV0IGJ1ZmZlclBvc2l0aW9uID0gZWRpdG9yLmdldExhc3RDdXJzb3IoKS5nZXRCdWZmZXJQb3NpdGlvbigpXG4gICAgICBsZXQgc2NvcGVEZXNjcmlwdG9yID0gZWRpdG9yLmdldFJvb3RTY29wZURlc2NyaXB0b3IoKVxuICAgICAgbGV0IHByZWZpeCA9ICdhYidcblxuICAgICAgbGV0IHJlc3VsdHMgPSBwcm92aWRlci5nZXRTdWdnZXN0aW9ucyh7ZWRpdG9yLCBidWZmZXJQb3NpdGlvbiwgc2NvcGVEZXNjcmlwdG9yLCBwcmVmaXh9KVxuICAgICAgZXhwZWN0KHJlc3VsdHMpLnRvQmVVbmRlZmluZWQoKVxuICAgIH0pXG5cbiAgICBpdCgnYWRkcyB3b3JkcyB0byB0aGUgd29yZGxpc3Qgd2l0aCB1bmljb2RlIGNoYXJhY3RlcnMnLCAoKSA9PiB7XG4gICAgICBhdG9tLmNvbmZpZy5zZXQoJ2F1dG9jb21wbGV0ZS1wbHVzLmVuYWJsZUV4dGVuZGVkVW5pY29kZVN1cHBvcnQnLCB0cnVlKVxuICAgICAgZWRpdG9yLm1vdmVUb0JvdHRvbSgpXG4gICAgICBlZGl0b3IubW92ZVRvQmVnaW5uaW5nT2ZMaW5lKClcbiAgICAgIGxldCBwcm92aWRlciA9IGF1dG9jb21wbGV0ZU1hbmFnZXIucHJvdmlkZXJNYW5hZ2VyLmRlZmF1bHRQcm92aWRlclxuXG4gICAgICBleHBlY3QocHJvdmlkZXIudG9rZW5MaXN0LmdldFRva2VuKCdzb23Ek3RoaW5nTmV3JykpLnRvQmVVbmRlZmluZWQoKVxuICAgICAgZWRpdG9yLmluc2VydFRleHQoJ3NvbcSTdGhpbmdOZXcnKVxuICAgICAgZXhwZWN0KHByb3ZpZGVyLnRva2VuTGlzdC5nZXRUb2tlbignc29txJN0aGluZ05ldycpKS50b0JlKCdzb23Ek3RoaW5nTmV3JylcbiAgICB9KVxuICB9KVxufSlcbiJdfQ==